From 7d8654e7020a7ce71b91c69c85d4b53ecd440556 Mon Sep 17 00:00:00 2001
From: andixlm <andixev@gmail.com>
Date: Sun, 26 Oct 2014 22:24:26 +0600
Subject: [PATCH] Add BT Support for S2Plus

Change-Id: I3f24fba559b837d614406ad9a6a19dfaf26ca06d
---
 src/userial_vendor.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/userial_vendor.c b/src/userial_vendor.c
index 5233d19..f664f16 100755
--- a/src/userial_vendor.c
+++ b/src/userial_vendor.c
@@ -183,6 +183,10 @@ int userial_vendor_open(tUSERIAL_CFG *p_cfg)
     uint16_t parity;
     uint8_t stop_bits;
 
+#if (BT_WAKE_VIA_USERIAL_IOCTL==TRUE)
+    int ldisc;
+#endif
+
     vnd_userial.fd = -1;
 
     if (!userial_to_tcio_baud(p_cfg->baud, &baud))
@@ -252,6 +256,9 @@ int userial_vendor_open(tUSERIAL_CFG *p_cfg)
     tcsetattr(vnd_userial.fd, TCSANOW, &vnd_userial.termios);
 
 #if (BT_WAKE_VIA_USERIAL_IOCTL==TRUE)
+    // Switch to N_BRCM_HCI line disclipline for ioctl to work
+    ldisc = 25; // N_BRCM_HCI
+    ioctl(vnd_userial.fd, TIOCSETD, &ldisc);
     userial_ioctl_init_bt_wake(vnd_userial.fd);
 #endif
 
-- 
1.9.1

